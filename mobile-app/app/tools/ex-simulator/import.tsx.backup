import React, { useState } from 'react';
import { View, Text, ScrollView, TouchableOpacity, TextInput, Alert, ActivityIndicator } from 'react-native';
import { useRouter } from 'expo-router';
import { LinearGradient } from 'expo-linear-gradient';
import { Upload, FileText, Image as ImageIcon, ArrowRight, CheckCircle } from 'lucide-react-native';
import * as DocumentPicker from 'expo-document-picker';
import * as ImagePicker from 'expo-image-picker';
import { supabase } from '../../../lib/supabase';
import { parseWhatsAppExport, parseTelegramExport, analyzePersonality, ParsedMessage, extractChatFromImages } from '../../../lib/exSimulator';
import ExportGuide from '../../../components/ExportGuide';

type ImportStep = 'guide' | 'upload' | 'preview' | 'analyzing' | 'complete';

export default function ImportChat() {
    const router = useRouter();
    const [step, setStep] = useState<ImportStep>('guide');
    const [importType, setImportType] = useState<'whatsapp' | 'telegram' | 'text' | 'screenshots'>('whatsapp');
    const [rawText, setRawText] = useState('');
    const [parsedMessages, setParsedMessages] = useState<ParsedMessage[]>([]);
    const [exName, setExName] = useState('');
    try {
        const result = await ImagePicker.launchImageLibraryAsync({
            mediaTypes: ImagePicker.MediaTypeOptions.Images,
            allowsMultipleSelection: true,
            quality: 0.8,
            base64: true,
        });

        if (result.canceled) return;

        setAnalyzing(true);

        // Extract base64 strings
        const base64Images = result.assets.map(asset => asset.base64).filter(Boolean) as string[];

        if (base64Images.length === 0) {
            Alert.alert('Error', 'No se pudieron procesar las im√°genes');
            setAnalyzing(false);
            return;
        }

        Alert.alert('Procesando', 'Analizando capturas... Esto puede tardar unos segundos.');

        const messages = await extractChatFromImages(base64Images);

        if (messages.length < 5) {
            Alert.alert('Aviso', 'Se encontraron pocos mensajes. Intenta subir m√°s capturas para un mejor an√°lisis.');
        }

        setParsedMessages(messages);
        setStep('preview');
    } catch (error) {
        console.error('Error uploading images:', error);
        Alert.alert('Error', 'No se pudieron procesar las capturas.');
    } finally {
        setAnalyzing(false);
    }
};

const handleTextPaste = () => {
    if (!rawText.trim()) {
        Alert.alert('Error', 'Por favor pega el contenido del chat');
        return;
    }

    // Check text size (limit to prevent crashes)
    const MAX_LENGTH = 500000; // ~500KB of text
    if (rawText.length > MAX_LENGTH) {
        Alert.alert(
            'Texto Muy Largo',
            `El texto es demasiado largo (${(rawText.length / 1000).toFixed(0)}KB). Por favor, pega solo los √∫ltimos 3-6 meses de conversaci√≥n.\n\nM√°ximo: ~500KB`,
            [{ text: 'Entendido' }]
        );
        return;
    }

    const messages = parseWhatsAppExport(rawText);

    // Limit messages
    if (messages.length > 1000) {
        Alert.alert(
            'Muchos Mensajes',
            `Se encontraron ${messages.length} mensajes. Usaremos solo los √∫ltimos 1000 para mejor rendimiento.`,
            [
                { text: 'Cancelar', style: 'cancel' },
                {
                    text: 'Continuar',
                    onPress: () => {
                        const recentMessages = messages.slice(-1000);
                        setParsedMessages(recentMessages);
                        setStep('preview');
                    }
                }
            ]
        );
        return;
    }

    if (messages.length < 10) {
        Alert.alert('Error', 'Se necesitan al menos 10 mensajes para crear un perfil.');
        return;
    }

    setParsedMessages(messages);
    setStep('preview');
};

const handleAnalyze = async () => {
    if (!exName.trim()) {
        Alert.alert('Error', 'Por favor ingresa el nombre de tu ex');
        return;
    }

    setStep('analyzing');
    setAnalyzing(true);

    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('Usuario no autenticado');

        // Analyze personality
        const profile = await analyzePersonality(parsedMessages, exName);

        // Save to database
        const { data: exProfile, error: profileError } = await supabase
            .from('ex_profiles')
            .insert({
                user_id: user.id,
                ex_name: exName,
                profile_data: profile,
                message_count: parsedMessages.length,
                date_range_start: parsedMessages[0]?.timestamp,
                date_range_end: parsedMessages[parsedMessages.length - 1]?.timestamp
            })
            .select()
            .single();

        if (profileError) throw profileError;

        // Save chat import
        await supabase.from('chat_imports').insert({
            ex_profile_id: exProfile.id,
            import_type: importType,
            raw_data: rawText.substring(0, 10000), // Only save first 10KB to avoid DB issues
            processed_messages: parsedMessages.slice(0, 100) // Only save first 100 messages
        });

        setStep('complete');

        setTimeout(() => {
            router.replace('/tools/ex-simulator' as any);
        }, 2000);
    } catch (error) {
        console.error('Error analyzing:', error);
        Alert.alert('Error', 'No se pudo analizar el perfil. Intenta de nuevo.');
        setStep('preview');
    } finally {
        setAnalyzing(false);
    }
};

if (step === 'guide') {
    return (
        <ExportGuide onClose={() => setStep('upload')} />
    );
}

if (step === 'analyzing') {
    return (
        <View className="flex-1 bg-[#0a0a0a] items-center justify-center px-6">
            <ActivityIndicator size="large" color="#a855f7" />
            <Text className="text-white text-xl font-bold mt-6 text-center">
                Analizando personalidad...
            </Text>
            <Text className="text-gray-400 text-center mt-2">
                Esto puede tardar unos segundos
            </Text>
        </View>
    );
}

if (step === 'complete') {
    return (
        <View className="flex-1 bg-[#0a0a0a] items-center justify-center px-6">
            <CheckCircle size={80} color="#22c55e" />
            <Text className="text-white text-2xl font-bold mt-6 text-center">
                ¬°Perfil Creado!
            </Text>
            <Text className="text-gray-400 text-center mt-2">
                Redirigiendo...
            </Text>
        </View>
    );
}

return (
    <View className="flex-1 bg-[#0a0a0a]">
        <LinearGradient
            colors={['#1a1a2e', '#16213e', '#0a0a0a']}
            className="flex-1"
        >
            <ScrollView className="flex-1 px-6 pt-6">
                {step === 'upload' && (
                    <>
                        <Text className="text-white text-3xl font-bold mb-2">
                            Importar Conversaci√≥n
                        </Text>
                        <Text className="text-gray-400 mb-6">
                            Selecciona el formato de tu chat exportado
                        </Text>

                        {/* Warning for large files */}
                        <View className="bg-yellow-500/10 border border-yellow-500/30 rounded-2xl p-4 mb-6">
                            <Text className="text-yellow-400 font-bold mb-2">‚ö†Ô∏è Importante</Text>
                            <Text className="text-gray-300 text-sm leading-6">
                                ‚Ä¢ M√°ximo 2MB por archivo{'\n'}
                                ‚Ä¢ Exporta solo 3-6 meses de conversaci√≥n{'\n'}
                                ‚Ä¢ Exporta SIN medios para reducir tama√±o
                            </Text>
                        </View>

                        {/* Format Selector */}
                        <View className="mb-6">
                            <TouchableOpacity
                                onPress={() => setImportType('whatsapp')}
                                className={`border rounded-2xl p-4 mb-3 ${importType === 'whatsapp'
                                    ? 'bg-green-500/20 border-green-500'
                                    : 'bg-white/5 border-white/10'
                                    }`}
                            >
                                <Text className={`font-bold text-lg ${importType === 'whatsapp' ? 'text-green-400' : 'text-white'
                                    }`}>
                                    üì± WhatsApp (.txt)
                                </Text>
                            </TouchableOpacity>

                            <TouchableOpacity
                                onPress={() => setImportType('telegram')}
                                className={`border rounded-2xl p-4 mb-3 ${importType === 'telegram'
                                    ? 'bg-blue-500/20 border-blue-500'
                                    : 'bg-white/5 border-white/10'
                                    }`}
                            >
                                <Text className={`font-bold text-lg ${importType === 'telegram' ? 'text-blue-400' : 'text-white'
                                    }`}>
                                    ‚úàÔ∏è Telegram (.json)
                                </Text>
                            </TouchableOpacity>

                            <TouchableOpacity
                                onPress={() => setImportType('screenshots')}
                                className={`border rounded-2xl p-4 mb-3 ${importType === 'screenshots'
                                    ? 'bg-pink-500/20 border-pink-500'
                                    : 'bg-white/5 border-white/10'
                                    }`}
                            >
                                <Text className={`font-bold text-lg ${importType === 'screenshots' ? 'text-pink-400' : 'text-white'
                                    }`}>
                                    üì∏ Capturas de Pantalla
                                </Text>
                            </TouchableOpacity>

                            <TouchableOpacity
                                onPress={() => setImportType('text')}
                                className={`border rounded-2xl p-4 ${importType === 'text'
                                    ? 'bg-purple-500/20 border-purple-500'
                                    : 'bg-white/5 border-white/10'
                                    }`}
                            >
                                <Text className={`font-bold text-lg ${importType === 'text' ? 'text-purple-400' : 'text-white'
                                    }`}>
                                    üìù Pegar Texto
                                </Text>
                            </TouchableOpacity>
                        </View>

                        {/* Upload/Paste Area */}
                        {importType === 'text' && (
                            <View className="mb-6">
                                <Text className="text-white font-semibold mb-2">
                                    Pega el contenido del chat:
                                </Text>
                                <TextInput
                                    className="bg-white/5 border border-white/10 rounded-2xl p-4 text-white min-h-[200px]"
                                    placeholder="Pega aqu√≠ el contenido exportado..."
                                    placeholderTextColor="#6b7280"
                                    multiline
                                    value={rawText}
                                    onChangeText={setRawText}
                                    style={{ textAlignVertical: 'top' }}
                                    maxLength={500000}
                                />
                                <TouchableOpacity
                                    onPress={handleTextPaste}
                                    className="bg-purple-600 rounded-2xl py-4 mt-4"
                                >
                                    <Text className="text-white text-center font-bold text-lg">
                                        Procesar Texto
                                    </Text>
                                </TouchableOpacity>
                            </View>
                        )}

                        {importType === 'screenshots' && (
                            <TouchableOpacity
                                onPress={handleImageUpload}
                                className="bg-white/5 border-2 border-dashed border-white/20 rounded-2xl p-8 items-center mb-6"
                            >
                                <ImageIcon size={48} color="#ec4899" />
                                <Text className="text-white font-bold text-lg mt-4">
                                    Seleccionar Capturas
                                </Text>
                                <Text className="text-gray-400 text-center mt-2">
                                    Sube capturas de tu chat (WhatsApp, Instagram, etc.)
                                </Text>
                            </TouchableOpacity>
                        )}

                        {(importType === 'whatsapp' || importType === 'telegram') && (
                            <TouchableOpacity
                                onPress={handleFileUpload}
                                className="bg-white/5 border-2 border-dashed border-white/20 rounded-2xl p-8 items-center mb-6"
                            >
                                <Upload size={48} color="#a855f7" />
                                <Text className="text-white font-bold text-lg mt-4">
                                    Subir Archivo
                                </Text>
                                <Text className="text-gray-400 text-center mt-2">
                                    {importType === 'whatsapp' ? 'Archivo .txt de WhatsApp' : 'Archivo .json de Telegram'}
                                </Text>
                            </TouchableOpacity>
                        )}

                        <TouchableOpacity
                            onPress={() => setStep('guide')}
                            className="bg-blue-500/20 border border-blue-500/30 rounded-2xl p-4"
                        >
                            <Text className="text-blue-400 text-center font-semibold">
                                üìö Ver Gu√≠a de Exportaci√≥n
                            </Text>
                        </TouchableOpacity>
                    </>
                )}

                {step === 'preview' && (
                    <>
                        <Text className="text-white text-3xl font-bold mb-2">
                            Vista Previa
                        </Text>
                        <Text className="text-gray-400 mb-6">
                            {parsedMessages.length} mensajes detectados
                        </Text>

                        {/* Name Inputs */}
                        <View className="mb-6">
                            <Text className="text-white font-semibold mb-2">
                                Nombre de tu ex:
                            </Text>
                            <TextInput
                                className="bg-white/5 border border-white/10 rounded-2xl p-4 text-white mb-4"
                                placeholder="Ej: Mar√≠a"
                                placeholderTextColor="#6b7280"
                                value={exName}
                                onChangeText={setExName}
                            />
                        </View>

                        {/* Message Preview */}
                        <View className="bg-white/5 border border-white/10 rounded-2xl p-4 mb-6">
                            <Text className="text-white font-semibold mb-3">
                                Primeros mensajes:
                            </Text>
                            {parsedMessages.slice(0, 5).map((msg, idx) => (
                                <Text key={idx} className="text-gray-300 text-sm mb-2">
                                    {msg.sender === 'user' ? 'üë§' : 'üí¨'} {msg.content.substring(0, 50)}...
                                </Text>
                            ))}
                        </View>

                        <TouchableOpacity
                            onPress={handleAnalyze}
                            className="bg-purple-600 rounded-2xl py-4 flex-row items-center justify-center"
                        >
                            <Text className="text-white font-bold text-lg mr-2">
                                Analizar Personalidad
                            </Text>
                            <ArrowRight size={20} color="white" />
                        </TouchableOpacity>
                    </>
                )}
            </ScrollView>
        </LinearGradient>
    </View>
);
}
