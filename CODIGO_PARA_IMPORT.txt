// ========================================
// MODIFICACIONES PARA import.tsx
// ========================================

// 1. AGREGAR ESTOS IMPORTS (despu√©s de l√≠nea 10)
import { generateMasterPrompt } from '../../../lib/masterPromptGenerator';
import { saveMasterPrompt } from '../../../lib/masterPromptSupabase';

// 2. AGREGAR ESTA FUNCI√ìN DESPU√âS DE handleAnalyze (busca donde termina analyzePersonality)
// Ubicaci√≥n: Despu√©s de que profile se asigna exitosamente

// Busca esta secci√≥n (aproximadamente l√≠nea 370):
/*
const profile = await analysisPromise;
console.log('[handleAnalyze] ‚úÖ Analysis complete:', profile);

// Guardar en localStorage
const profileData = {
    id: Date.now().toString(),
    exName,
    profile,
    messageCount: parsedData.length,
    createdAt: new Date().toISOString()
};
*/

// AGREGAR DESPU√âS DE profileData (ANTES de localStorage.setItem):

// ========== NUEVO C√ìDIGO: MASTER PROMPT GENERATION ==========
console.log('[handleAnalyze] üß† Starting Master Prompt generation...');

// Obtener exSenderName (el nombre real en los mensajes)
const senderCounts = new Map<string, number>();
parsedData.forEach(msg => {
    senderCounts.set(msg.sender, (senderCounts.get(msg.sender) || 0) + 1);
});

const exNameLower = exName.toLowerCase().trim();
const exSenderName = Array.from(senderCounts.keys()).find(name => {
    const nameLower = name.toLowerCase().trim();
    return nameLower === exNameLower ||
        nameLower.includes(exNameLower) ||
        exNameLower.includes(nameLower);
});

if (!exSenderName) {
    console.error('[handleAnalyze] Could not identify ex sender name');
    // Continuar sin Master Prompt
} else {
    try {
        // Generar Master Prompt
        const masterPromptResult = await generateMasterPrompt(
            parsedData,
            exSenderName,
            exName,
            (progress, status, timeRemaining) => {
                setProgress(progress);
                setAnalysisStatus(status);
                console.log(`[MasterPrompt] ${progress}% - ${status} (${timeRemaining ? timeRemaining + 's' : ''})`);
            }
        );

        console.log('[handleAnalyze] ‚úÖ Master Prompt generated:', {
            tokenCount: masterPromptResult.tokenCount,
            duration: masterPromptResult.analysisDurationSeconds
        });

        // Actualizar profileData con Master Prompt
        profileData.masterPrompt = masterPromptResult.masterPrompt;
        profileData.tokenCount = masterPromptResult.tokenCount;
        profileData.categoriesAnalyzed = masterPromptResult.categoriesAnalyzed;

        // Intentar guardar en Supabase
        const { data: { user } } = await supabase.auth.getUser();
        
        if (user?.id) {
            try {
                // Primero guardar el perfil b√°sico
                const { data: savedProfile, error: profileError } = await supabase
                    .from('ex_profiles')
                    .insert({
                        user_id: user.id,
                        ex_name: exName,
                        profile_data: profile,
                        message_count: parsedData.length
                    })
                    .select('id')
                    .single();

                if (!profileError && savedProfile) {
                    const supabaseProfileId = savedProfile.id;
                    profileData.supabaseId = supabaseProfileId;

                    console.log('[handleAnalyze] Profile saved to Supabase:', supabaseProfileId);

                    // Guardar Master Prompt
                    await saveMasterPrompt({
                        exProfileId: supabaseProfileId,
                        masterPrompt: masterPromptResult.masterPrompt,
                        tokenCount: masterPromptResult.tokenCount,
                        version: 1,
                        analysisDurationSeconds: masterPromptResult.analysisDurationSeconds,
                        categoriesAnalyzed: masterPromptResult.categoriesAnalyzed
                    });

                    console.log('[handleAnalyze] ‚úÖ Master Prompt saved to Supabase');
                }
            } catch (supabaseErr) {
                console.warn('[handleAnalyze] Could not save to Supabase:', supabaseErr);
                // Continuar con localStorage
            }
        } else {
            console.log('[handleAnalyze] No user logged in, saving only to localStorage');
        }
    } catch (masterPromptErr) {
        console.error('[handleAnalyze] Error generating Master Prompt:', masterPromptErr);
        // Continuar sin Master Prompt (usar an√°lisis b√°sico)
    }
}
// ========== FIN NUEVO C√ìDIGO ==========

// Despu√©s de esto contin√∫a con:
// localStorage.setItem('exSimulator_currentProfile', JSON.stringify(profileData));
// router.replace('/tools/ex-simulator' as any);
